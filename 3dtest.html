<!DOCTYPE html>

<html>

<head>
    <title>3D Cancer Model Test</title>
    <script type="text/javascript" src="libs/three.js"></script>
    <script type="text/javascript" src="libs/dat.gui.js"></script>
    <script type="text/javascript" src="libs/stats.js"></script>
    <script type="text/javascript" src="libs/OrbitControls.js"></script>
	<script type="text/javascript" src="libs/rcolor.js"></script>
    <style>
        body {
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div id="Stats-output">
</div>
<!-- Div which will hold the Output -->
<div id="WebGL-output">
</div>

<script type="text/javascript">

    function init() {
			// set up some variables, including Ken's step log
		var l = [];
l[1]=
[{added: 5},
{added: 37},
{added: 3},
{added: 4},
{added: 45},
{added: 39},
{added: 40},
{added: 18},
{added: 26},
{added: 21},
{added: 41},
{added: 48},
{added: 28},
{added: 15},
{added: 9},
{added: 13},
{added: 20},
{added: 35},
{added: 30},
{added: 11},
{added: 43},
{added: 19},
{added: 47},
{added: 12},
{added: 32},
{added: 50},
{added: 8},
{added: 42},
{added: 33},
{added: 27},
{added: 29},
{added: 2},
{added: 34},
{added: 17},
{added: 46},
{added: 25},
{added: 24},
{added: 7},
{added: 31},
{added: 23},
{added: 38},
{added: 44},
{added: 1},
{added: 6},
{added: 16},
{added: 14},
{added: 10},
{added: 49},
{added: 36},
{added: 22},
 {who: 34, changed: {x: 1, y: 0}},
 {who: 35, changed: {x: -2, y: -1}},
 {who: 19, changed: {x: 3, y: 1}},
 {who: 37, changed: {x: 4, y: -2}},
 {who: 10, changed: {x: -5, y: -2}},
 {who: 7, changed: {x: -3, y: -1}},
 {who: 27, changed: {x: -1, y: 1}},
 {who: 25, changed: {x: -2, y: 1}},
 {who: 3, changed: {x: 3, y: -1}},
 {who: 41, changed: {x: -3, y: 1}},
 {who: 22, changed: {x: -2, y: -2}},
 {who: 12, changed: {x: 4, y: -1}},
 {who: 14, changed: {x: -5, y: -1}},
 {who: 4, changed: {x: -2, y: -3}},
 {who: 40, changed: {x: 2, y: -2}},
 {who: 45, changed: {x: 2, y: -3}},
 {who: 15, changed: {x: -3, y: -3}},
 {who: 33, changed: {x: -5, y: -3}},
 {who: 13, changed: {x: 2, y: -1}},
 {who: 44, changed: {x: 0, y: -1}},
 {who: 43, changed: {x: 3, y: -3}},
 {who: 24, changed: {x: 1, y: -3}},
 {who: 28, changed: {x: -1, y: -2}},
 {who: 17, changed: {x: -4, y: 0}},
 {who: 18, changed: {x: -4, y: -3}},
 {who: 6, changed: {x: -4, y: 1}},
 {who: 26, changed: {x: -3, y: 0}},
 {who: 39, changed: {x: -5, y: 0}},
 {who: 32, changed: {x: 1, y: -1}},
 {who: 47, changed: {x: -2, y: 0}},
 {who: 38, changed: {x: 2, y: 1}},
 {who: 29, changed: {x: -4, y: -1}},
 {who: 36, changed: {x: 0, y: -3}},
 {who: 11, changed: {x: 0, y: 1}},
 {who: 46, changed: {x: -3, y: -2}},
 {who: 5, changed: {x: -1, y: -1}},
 {who: 50, changed: {x: 4, y: 1}},
 {who: 1, changed: {x: 3, y: -2}},
 {who: 48, changed: {x: 0, y: 0}},
 {who: 49, changed: {x: 1, y: 1}},
 {who: 8, changed: {x: 3, y: 0}},
 {who: 21, changed: {x: 1, y: -2}},
 {who: 30, changed: {x: 2, y: 0}},
 {who: 31, changed: {x: 0, y: -2}},
 {who: 16, changed: {x: 4, y: 0}},
 {who: 2, changed: {x: -4, y: -2}},
 {who: 20, changed: {x: -1, y: 0}},
 {who: 23, changed: {x: -5, y: 1}},
 {who: 42, changed: {x: 4, y: -3}},
 {who: 9, changed: {x: -1, y: -3}}];
l[1159]=
[{added: 2955},
 {who: 2955, changed: {x: 1, y: -4}}];
l[1354]=
[{added: 3014},
 {who: 3014, changed: {x: 5, y: 2}}];
l[1387]=
[{added: 3073},
 {who: 45, changed: {x: 2, y: -4}},
 {who: 40, changed: {x: 2, y: -3}},
 {who: 31, changed: {x: 1, y: -2}},
 {who: 21, changed: {x: 2, y: -2}},
 {who: 3073, changed: {x: 0, y: -2}}];
l[1940]=
[{added: 3132},
 {who: 3132, changed: {x: 2, y: -1}},
 {who: 13, changed: {x: 3, y: -1}},
 {who: 12, changed: {x: 5, y: -1}},
 {who: 3, changed: {x: 4, y: -1}}];
l[2183]=
[{added: 3191},
 {who: 13, changed: {x: 3, y: -2}},
 {who: 1, changed: {x: 3, y: -1}},
 {who: 3191, changed: {x: 4, y: -1}},
 {who: 3, changed: {x: 5, y: 0}}];
l[2385]=
[{added: 3250},
 {who: 3250, changed: {x: 2, y: -1}},
 {who: 3132, changed: {x: 2, y: -2}},
 {who: 21, changed: {x: 2, y: -3}},
 {who: 40, changed: {x: 3, y: -4}}];
l[2564]=
[{added: 3309},
 {who: 3309, changed: {x: -2, y: 2}}];
l[2617]=
[{added: 3368},
 {who: 3368, changed: {x: 5, y: -2}}];
l[5383]=
[{added: 3427},
 {who: 8, changed: {x: 4, y: -1}},
 {who: 19, changed: {x: 4, y: 2}},
 {who: 3427, changed: {x: 3, y: -2}},
 {who: 3191, changed: {x: 3, y: -1}},
 {who: 3250, changed: {x: 1, y: -1}},
 {who: 30, changed: {x: 3, y: 1}},
 {who: 32, changed: {x: 2, y: -1}},
 {who: 13, changed: {x: 3, y: 0}},
 {who: 1, changed: {x: 2, y: 0}}];
l[5585]=
[{added: 3486},
 {who: 45, changed: {x: 1, y: -5}},
 {who: 3486, changed: {x: 2, y: -4}}];
l[5764]=
[{added: 3545},
 {who: 3545, changed: {x: -3, y: 2}}];
l[5817]=
[{added: 3604},
 {who: 3604, changed: {x: 4, y: -1}},
 {who: 16, changed: {x: 5, y: 1}},
 {who: 8, changed: {x: 4, y: 0}}];
l[8583]=
[{added: 3663},
 {who: 3663, changed: {x: 4, y: 1}},
 {who: 50, changed: {x: 3, y: 2}}];
l[8785]=
[{added: 3722},
 {who: 3132, changed: {x: -1, y: -1}},
 {who: 3250, changed: {x: 2, y: -1}},
 {who: 31, changed: {x: 2, y: -2}},
 {who: 3722, changed: {x: 0, y: -2}},
 {who: 22, changed: {x: -2, y: -3}},
 {who: 5, changed: {x: 1, y: -1}},
 {who: 28, changed: {x: -2, y: -2}},
 {who: 3073, changed: {x: -1, y: -2}},
 {who: 32, changed: {x: 1, y: -2}},
 {who: 4, changed: {x: -1, y: -4}}];
l[8964]=
[{added: 3781},
 {who: 3781, changed: {x: -4, y: 2}}];
l[9017]=
[{added: 3840},
 {who: 31, changed: {x: 3, y: -2}},
 {who: 3840, changed: {x: 3, y: 0}},
 {who: 3191, changed: {x: 3, y: -3}},
 {who: 3427, changed: {x: 2, y: -2}},
 {who: 43, changed: {x: 4, y: -4}},
 {who: 13, changed: {x: 3, y: -1}}];
		var step = 0;
		var paused = 0;
		var pausedstring = "";
		var colorgen = new RColor;
		
		//set up scene and camera
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.userData = { keepMe: true };
		
		//create renderer object
        var renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(new THREE.Color(0xEEEEEE, 1.0));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;
        
		//initialise click and drag rotation
		controls = new THREE.OrbitControls( camera, renderer.domElement );
		controls.enableDamping = true;
		controls.dampingFactor = 0.25;
		controls.enableZoom = false;
		
        // position and point the camera to the center of the scene
        camera.position.x = -10;
        camera.position.y = 15;
        camera.position.z = 10;
        camera.lookAt(scene.position);

        // add ambient lighting
        var ambientLight = new THREE.AmbientLight(0x0c0c0c);
		ambientLight.userData = { keepMe: true };
        scene.add(ambientLight);

        //add upper spotlight (1)
        var spotLight1 = new THREE.SpotLight(0xffffff);
        spotLight1.position.set(-40, 60, -10);
        spotLight1.castShadow = true;
		spotLight1.userData = { keepMe: true };
        scene.add(spotLight1);
		
		//add lower spotlight (2)
        var spotLight2 = new THREE.SpotLight(0xffffff);
        spotLight2.position.set(-40, -60, -10);
        spotLight2.castShadow = true;
		spotLight1.userData = { keepMe: true };
        scene.add(spotLight2);

        // add the output of the renderer to the dom
        document.getElementById("WebGL-output").appendChild(renderer.domElement);

			//set up the dat.gui controls for steps-per-frame, pause, unpause and reset gui elements
			var controls = new function () {
            this.stepsperframe = 5;
			this.pause = function () {paused = 1; pausedstring = "PAUSED"}
			this.unpause = function () {paused = 0; pausedstring = ""}
			this.resetsteps = function () {step = 0; clearScene ();}
											};
			var gui = new dat.GUI();
			gui.add(controls, 'stepsperframe').min(1).max(100).step(1);
			gui.add(controls, 'pause')
			gui.add(controls, 'unpause')
			gui.add(controls, 'resetsteps')
        
		
		//set up step count (and paused) text div
		var stepcounttext = document.createElement('div');
		stepcounttext.style.position = 'absolute';
		stepcounttext.style.width = 100;
		stepcounttext.style.height = 100;
		stepcounttext.style.backgroundColor = "blue";
		stepcounttext.innerHTML = "no ticks yet";
		stepcounttext.style.top = 0 + 'px';
		stepcounttext.style.left = 100 + 'px';
		document.body.appendChild(stepcounttext);


        //call render function
        renderScene();
		
		// a function to create a hitlist of killable meshes and kill them
		function clearScene() {
			var to_remove = [];
			scene.traverse ( function( child ) {
			if ( child instanceof THREE.Mesh && !child.userData.keepMe === true ) {
				to_remove.push( child );
         }
    } );

			for ( var i = 0; i < to_remove.length; i++ ) {
					scene.remove( to_remove[i] );
    }
}
	// ugly function that is the main draw loop and log->object processor
	function renderScene() {
            //grab how many steps (log elements) to process between drawing each frame from dat.gui
			var stepsperframe = controls.stepsperframe;
			//process some frames before calling renderer again
			for (i = 0; i < stepsperframe; i++) 
			{ 
				//increment step count and update step div if we're not paused and not finished...
				if (step < l.length && paused < 1) {step++; stepcounttext.innerHTML = "Step "+step+" of "+(l.length-1)+" "+pausedstring;}
				//... or say we're done if we are
				else {stepcounttext.innerHTML = l.length-1+" steps completed "+pausedstring;}	
			
				//hack of Ken's log processing code that makes/removes/moves cells in scene 'live'
				var events = l[step];
				if (events) {
				events.forEach(function (event) {
											if (event.added) {
															var randomcol = colorgen.get(true)
															var sphereGeometry = new THREE.SphereGeometry(0.75, 20, 20);
															var sphereMaterial = new THREE.MeshPhongMaterial({color: randomcol});
															var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
															sphere.position.x = 1000;
															sphere.position.y = 1000;
															sphere.position.z = 1000;
															scene.add(sphere);
															sphere.name = "cell_" + event.added;
															}
											else if (event.removed) {
															var victim = scene.getObjectByName( "cell_" + event.removed );
															scene.remove(victim);
																	}
											else if (event.changed) {
															var vehicle = scene.getObjectByName( "cell_" + event.who );
															vehicle.position.x = event.changed.x;
															vehicle.position.y = 0;
															vehicle.position.z = event.changed.y;
																	}
											});
						}
			}
            // render using requestAnimationFrame
            requestAnimationFrame(renderScene);
            renderer.render(scene, camera);
        }


    }
    window.onload = init;

</script>
</body>
</html>